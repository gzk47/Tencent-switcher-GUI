name: Build Tencent Switcher GUI - 20251120
on:
  workflow_dispatch:

jobs:
  build-switch:
    name: Build for Nintendo Switch
    runs-on: ubuntu-latest
    container: devkitpro/devkita64:latest
    steps:
      - name: Update system packages
        run: |
          apt-get update -o Acquire::Check-Valid-Until=false || true
          apt-get install -y --no-install-recommends git build-essential coreutils && \
          apt-get clean && rm -rf /var/lib/apt/lists/*
        shell: bash

      - name: Install libnx
        run: |
          git config --global --add safe.directory "*"
          git clone --recurse-submodules --depth 1 https://github.com/switchbrew/libnx.git
          cd libnx
          make install -j$(nproc)
        shell: bash

      - name: Checkout project
        uses: actions/checkout@master
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Fix Borealis submodule
        run: |
          if [ ! -d "lib/borealis/library" ]; then
            rm -rf lib/borealis
            git clone --recurse-submodules --depth 1 https://github.com/xfangfang/Borealis.git lib/borealis
          fi
        shell: bash

      - name: Set environment variables
        run: |
          echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
          echo "DEVKITARM=/opt/devkitpro/devkitARM" >> $GITHUB_ENV
          echo "PORTLIBS=/opt/devkitpro/portlibs/switch" >> $GITHUB_ENV
          echo "PATH=$DEVKITARM/bin:$DEVKITPRO/tools/bin:$PATH" >> $GITHUB_ENV
        shell: bash

      - name: Extract version
        run: |
          APP_VERSION=$(awk '/^APP_VERSION\s*:=/ {print $3}' Makefile 2>/dev/null)
          if [ -z "$APP_VERSION" ] || [ "$APP_VERSION" = "." ]; then
            APP_VERSION="0.1.2"
          fi
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=v${APP_VERSION}" >> $GITHUB_ENV
          echo "RELEASE_NAME=Tencent Switcher GUI v${APP_VERSION}" >> $GITHUB_ENV
          echo "Extracted version: ${APP_VERSION}"
        shell: bash

      - name: Build project
        run: |
          git config --global --add safe.directory `pwd`
          git submodule update --remote
          make -j$(nproc)
          ls -la ./*.nsp ./*.nro ./*.nacp || true
          if [ -f "tencent-switcher-gui.nsp" ]; then
            echo "PRODUCT_PATH=tencent-switcher-gui.nsp" >> $GITHUB_ENV
          elif [ -f "tencent-switcher-gui.nro" ]; then
            echo "PRODUCT_PATH=tencent-switcher-gui.nro" >> $GITHUB_ENV
          else
            echo "ERROR: No build product found!" && exit 1
          fi
        shell: bash
        timeout-minutes: 20

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RELEASE_NAME }}
          path: |
            ${{ env.PRODUCT_PATH }}
            ./*.nacp
            ./*.npdm
          retention-days: 30

      - name: Upload release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.PRODUCT_PATH }}
          tag: ${{ env.TAG_NAME }}
          release_name: ${{ env.RELEASE_NAME }}
          overwrite: true
          file_glob: false
          body: "Automatically built from GitHub Actions. Version: ${{ env.APP_VERSION }}"
